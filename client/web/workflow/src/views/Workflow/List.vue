<template>
  <b-container
    fluid="xl"
    class="py-3 d-flex flex-column"
  >
    <portal to="topbar-title">
      {{ $t('general:workflow-list') }}
    </portal>

    <c-resource-list
      :primary-key="primaryKey"
      :filter="filter"
      :sorting="sorting"
      :pagination="pagination"
      :fields="tableFields"
      :items="workflowList"
      :row-class="genericRowClass"
      :translations="{
        searchPlaceholder: $t('general:searchPlaceholder'),
        notFound: $t('general:resourceList.notFound'),
        noItems: $t('general:resourceList.noItems'),
        loading: $t('general:loading'),
        showingPagination: 'general:resourceList.pagination.showing',
        singlePluralPagination: 'general:resourceList.pagination.single',
        prevPagination: $t('general:resourceList.pagination.prev'),
        nextPagination: $t('general:resourceList.pagination.next'),
        resourceSingle: $t('general:workflow.single'),
        resourcePlural: $t('general:workflow.plural')
      }"
      clickable
      sticky-header
      class="h-100"
      @search="filterList"
      @row-clicked="handleRowClicked"
    >
      <template #header>
        <div class="flex-grow-1">
          <div class="wrap-with-vertical-gutters">
            <b-button
              v-if="canCreate"
              data-test-id="button-create-workflow"
              variant="primary"
              size="lg"
              class="float-left mr-1"
              :to="{ name: 'workflow.create' }"
            >
              {{ $t('general:new-workflow') }}
            </b-button>
            <import
              v-if="canCreate"
              :disabled="importProcessing"
              class="float-left mr-1"
              @import="importJSON"
            />
            <export
              class="float-left mr-1"
            />
            <c-permissions-button
              v-if="canGrant"
              resource="corteza::automation:workflow/*"
              :button-label="$t('general:permissions')"
              button-variant="light"
              class="float-left btn-lg"
            />
          </div>
        </div>
      </template>

      <template #toolbar>
        <b-col>
          <b-form-radio-group
            v-model="filter.subWorkflow"
            :options="[
              { value: 0, text: $t('general:without') },
              { value: 1, text: $t('general:including') },
              { value: 2, text: $t('general:only') }
            ]"
            buttons
            button-variant="outline-primary"
            size="sm"
            name="radio-btn-outline"
            @change="filterList"
          />
          {{ $t('general:subworkflows') }}
        </b-col>
        <b-col>
          <b-form-radio-group
            v-model="filter.disabled"
            :options="[
              { value: 0, text: $t('general:without') },
              { value: 1, text: $t('general:including') },
              { value: 2, text: $t('general:only') }
            ]"
            buttons
            button-variant="outline-primary"
            size="sm"
            name="radio-btn-outline"
            @change="filterList"
          />
          {{ $t('general:disabled') }}
        </b-col>
        <b-col>
          <b-form-radio-group
            v-model="filter.deleted"
            :options="[
              { value: 0, text: $t('general:without') },
              { value: 1, text: $t('general:including') },
              { value: 2, text: $t('general:only') }
            ]"
            buttons
            button-variant="outline-primary"
            size="sm"
            name="radio-btn-outline"
            @change="filterList"
          />
          {{ $t('general:deleted') }}
        </b-col>
      </template>

      <template #name="{ item: w }">
        {{ w.meta.name || w.handle }}
        <h5 class="d-inline-block ml-2">
          <b-badge
            v-if="w.meta.subWorkflow"
            variant="info"
          >
            {{ $t('general:subworkflow') }}
          </b-badge>
        </h5>
      </template>

      <template #enabled="{ item: w }">
        <font-awesome-icon
          :icon="['fas', w.enabled ? 'check' : 'times']"
        />
      </template>

      <template #changedAt="{ item }">
        {{ (item.deletedAt || item.updatedAt || item.createdAt) | locFullDateTime }}
      </template>

      <template #actions="{ item: w }">
        <b-dropdown
          v-if="w.canGrant || w.canDeleteWorkflow"
          variant="outline-light"
          toggle-class="d-flex align-items-center justify-content-center text-primary border-0 py-2 ml-1"
          no-caret
          lazy
          menu-class="m-0"
        >
          <template #button-content>
            <font-awesome-icon
              :icon="['fas', 'ellipsis-v']"
            />
          </template>

          <b-dropdown-item
            v-if="w.canGrant"
          >
            <c-permissions-button
              :tooltip="$t('permissions:resources.automation.workflow.tooltip')"
              :title="w.meta.name || w.handle || w.workflowID"
              :target="w.meta.name || w.handle || w.workflowID"
              :resource="`corteza::automation:workflow/${w.workflowID}`"
              button-variant="link text-decoration-none text-dark regular-font rounded-0"
              :button-label="$t('permissions:ui.label')"
              class="text-dark d-print-none border-0"
            />
          </b-dropdown-item>

          <b-dropdown-item
            v-if="w.canDeleteWorkflow && !w.deletedAt"
          >
            <c-input-confirm
              borderless
              variant="link"
              size="md"
              button-class="text-decoration-none text-dark regular-font rounded-0"
              class="w-100"
              @confirmed="handleDelete(w)"
            >
              <font-awesome-icon
                :icon="['far', 'trash-alt']"
                class="text-danger"
              />
              <span
                class="p-1"
              >
                {{ $t('delete') }}
              </span>
            </c-input-confirm>
          </b-dropdown-item>

          <b-dropdown-item
            v-if="w.canUndeleteWorkflow && w.deletedAt"
          >
            <c-input-confirm
              borderless
              variant="link"
              size="md"
              button-class="text-decoration-none text-dark regular-font rounded-0"
              class="w-100"
              @confirmed="handleDelete(w)"
            >
              <font-awesome-icon
                :icon="['far', 'trash-alt']"
                class="text-danger"
              />
              <span
                class="p-1"
              >
                {{ $t('undelete') }}
              </span>
            </c-input-confirm>
          </b-dropdown-item>
        </b-dropdown>
      </template>
    </c-resource-list>
  </b-container>
</template>

<script>
import { mapGetters } from 'vuex'
import Import from '../../components/Import'
import Export from '../../components/Export'
import listHelpers from '../../mixins/listHelpers'
import { components } from '@cortezaproject/corteza-vue'
const { CResourceList } = components

export default {
  i18nOptions: {
    namespaces: 'list',
  },

  name: 'WorkflowList',

  components: {
    Import,
    Export,
    CResourceList,
  },

  mixins: [
    listHelpers,
  ],

  data () {
    return {
      primaryKey: 'reportID',

      filter: {
        query: '',
        deleted: 0,
        subWorkflow: 1,
        disabled: 0,
      },

      sorting: {
        sortBy: 'handle',
        sortDesc: false,
      },

      newWorkflow: {},

      importProcessing: false,
    }
  },

  computed: {
    ...mapGetters({
      can: 'rbac/can',
    }),

    canGrant () {
      return this.can('automation/', 'grant')
    },

    canCreate () {
      return this.can('automation/', 'workflow.create')
    },

    tableFields () {
      return [
        {
          key: 'name',
          label: this.$t('general:columns.name'),
          sortable: false,
          tdClass: 'text-nowrap',
        },
        {
          key: 'enabled',
          label: this.$t('general:columns.enabled'),
          sortable: true,
          class: 'text-center',
        },
        {
          key: 'steps',
          label: this.$t('general:columns.steps'),
          tdClass: 'align-middle',
          class: 'text-center',
          formatter: steps => {
            return (steps || []).length
          },
        },
        {
          key: 'changedAt',
          label: this.$t('general:columns.changedAt'),
          sortable: true,
          class: 'text-right text-nowrap',
        },
        {
          key: 'actions',
          label: '',
          tdClass: 'text-right text-nowrap actions',
        },
      ]
    },

    workflowIDs () {
      return this.workflows.map(({ workflowID }) => workflowID)
    },

    userID () {
      if (this.$auth.user) {
        return this.$auth.user.userID
      }
      return undefined
    },
  },

  methods: {
    async importJSON (workflows = []) {
      this.importProcessing = true

      const skippedWorkflows = []

      await Promise.all(workflows.map(({ triggers = [], ...wf }) => {
        // Create workflow
        return this.$AutomationAPI.workflowCreate({ ownedBy: this.userID, runAs: '0', ...wf })
          .then(({ workflowID }) => {
            // Create triggers
            return Promise.all(triggers.map(trigger => {
              return this.$AutomationAPI.triggerCreate({
                ...trigger,
                workflowID,
                workflowStepID: trigger.stepID,
                ownedBy: this.userID,
              })
            }))
          })
          .catch(({ message }) => {
            // Skip workflow and add to skipped list
            if (wf.handle) {
              skippedWorkflows.push(`${wf.handle}${message ? ' - ' + message : ''};`)
            }
          })
      }))
        .then(() => {
          if (skippedWorkflows.length) {
            this.toastInfo(`${skippedWorkflows.join(' ')}`, this.$t('notification:import.skipped-workflows'))
          } else {
            this.toastSuccess(this.$t('notification:import.imported-workflows'))
          }
          this.$bvModal.hide('import')
        })
        .catch(this.toastErrorHandler(this.$t('notification:import.failed-import')))

      this.$root.$emit('bv::refresh::table', 'resource-list')

      this.importProcessing = false
    },

    workflowList () {
      return this.procListResults(this.$AutomationAPI.workflowList(this.encodeListParams()))
    },

    handleRowClicked (workflow) {
      this.$router.push({ name: 'workflow.edit', params: { workflowID: workflow.workflowID } })
    },

    handleDelete (workflow) {
      const { deletedAt = '' } = workflow
      const method = deletedAt ? 'workflowUndelete' : 'workflowDelete'
      const event = deletedAt ? 'undelete' : 'delete'
      const { workflowID } = workflow
      this.$AutomationAPI[method]({ workflowID })
        .then(() => {
          this.toastSuccess(this.$t(`notification:${event}.success`))
          this.filterList()
        })
        .catch(this.toastErrorHandler(this.$t(`notification:${event}.failed`)))
    },
  },
}
</script>
